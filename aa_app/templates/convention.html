{% extends "includes/helper.html" %}

{% block head %}
    <title>ArtisTally | {{convention}} Overview</title>
    
        <script>
            $(function() {
                // set rating
                {% if convention.avgRating != None %}
                    var rating = {{convention.avgRating}};
                    var percent = (rating/5)*100;
                    $("#average-rating").width(percent + "%"); // need the percentage
                {% endif %}
                
                //set cover photo
                {% if convention.image %}
                
                {% else %}
                
                {% endif %}
            });
            
            {% if currUser %}
                function setFavorite() {
                    var jsonDict = new Object();
                    jsonDict.conID = "{{convention.ID}}";
                    var ajaxObj = $.ajax({
                        url: "/api/convention/setUser",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setUser went wrong");
                        },
                    });
                }
             
                function unsetFavorite() {
                    var jsonDict = new Object();
                    jsonDict.conID = "{{convention.ID}}";
                    var ajaxObj = $.ajax({
                        url: "/api/convention/unsetUser",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setUser went wrong");
                        },
                    });
                }

                function makeWriteup() {
                    var jsonDict = new Object();
                    jsonDict.rating = $('input[name="ratingField"]:checked').val();
                    jsonDict.conID = "{{convention.ID}}";
                    jsonDict.review = $("#reviewField").val();
                    jsonDict.miscCosts = $("#miscCostsField").val();
                    $.ajax({
                        url: "/api/writeup/newWriteup",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        success: function(response) {
                            location.reload();
                        },
                        error: function(response) {
                            alert("newWriteup went wrong");
                        },
                    });
                }
            {% endif %}
        </script>
    
{% endblock %}

{% block body %}
    <div class="container">
        <div class="jumbotron-convention">
        </div>
        <div class="con-header">
            <div class="main-info">
                <h2>{{convention}}</h2>
                {{convention.location}} | {{convention.startDate}} - {{convention.endDate}} | <a href="{{convention.website}}">{{convention.website}}</a>
            </div>
            {% if currUser %}
            <div class="cell text-center">
                <div class="containery">
                    <div class="centery">
                        {% if currUserConWriteup %}
                            <a href="/writeup/{{currUserConWriteup.ID}}" class="btn btn-custom-blue">Edit Review</a>
                        {% else %}
                            <a href="#add-review" class="btn btn-custom-blue">Add Review</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="cell text-center">
                <div class="containery">
                    <div class="centery">
                        <div class="star-ratings-outer"><span id="average-rating" class="star-ratings-inner" style="width:0%"></span></div>
                        {{convention.writeups.count}} review{{convention.writeups.count|pluralize}}
                    </div>
                </div>
            </div>
        </div>

        <div class="section-wrapper border-wrapper">
            <h2 class="title-wrapper">Overview</h2>
            <br/>
            Show data from:
            <select>
                <option value="1">Last year</option>
                <option value="2">Last 2 years</option>
                <option value="3">Last 5 years</option>
                <option value="4">Beginning of time</option>
            </select>
            
            <br/>A total of {{convention.numAttenders}} attendees were at {{convention}}.
            <br/>We have data from a total of {{convention.users.count}} people from this period in time.
            {% if convention.avgUserProfit != None %}
                <br/>
                On average, each artist makes a total of ${{convention.avgUserProfit|floatformat:2}}.
            {% endif %}
            {% if convention.avgRating != None %}
                <br/>
                Convention has average rating {{convention.avgRating}} stars.
            {% endif %}
            <br/><!-- if only 2 kinds... if only 1 kind -->
            <br/>Top 3 most popular merchandise items sold:
            <br/>1. {{conTopItemKinds.0.0}} ({% widthratio conTopItemKinds.0.1 1 100 %}%)
            <br/>2. {{conTopItemKinds.1.0}} ({% widthratio conTopItemKinds.1.1 1 100 %}%)
            <br/>3. {{conTopItemKinds.2.0}} ({% widthratio conTopItemKinds.2.1 1 100 %}%)
            <br/>
            <br/>Top 3 most popular fandoms for merchandise:
            <br/>1. {{conTopItemFandoms.0.0}} ({% widthratio conTopItemFandoms.0.1 1 100 %}%)
            <br/>2. {{conTopItemFandoms.1.0}} ({% widthratio conTopItemFandoms.1.1 1 100 %}%)
            <br/>3. {{conTopItemFandoms.2.0}} ({% widthratio conTopItemFandoms.2.1 1 100 %}%)
        </div>
        
        {% if convention.prevCon %}
            prev con is: {{convention.prevCon}}
        {% endif %}
        {% if convention.nextCon %}
            next con is: {{convention.nextCon}}
        {% endif %}
        
        <div class="section-wrapper border-wrapper">
            <h2 class="title-wrapper">Reviews</h2>
            {% for writeup in convention.writeups.all|slice:":5" %}
                <div class="review-entry">
                    <div class="side-entry">
                        <a href="/user/{{writeup.user}}">
                        {% if writeup.user.image %}
                            <img src="{{writeup.user.image}}" class="user-icon-large">
                        {% else %}
                            <img src="/static/images/icon-default.png" class="user-icon-large">
                        {% endif %}</a>
                        <br/>
                        <a href="/user/{{writeup.user}}"><b>{{writeup.user}}</b></a>
                        <br/>
                        {{writeup.editTime|date:"M d, Y"}}
                        {% if writeup.user == currUser %}
                            <br/>
                            <a href="/writeup/{{currUserConWriteup.ID}}" class="btn btn-custom-blue">Edit Review</a>
                        {% endif %}
                    </div>
                    <div class="main-entry">
                        <div class="star-ratings-outer"><span id="{{writeup.user}}-rating" class="star-ratings-inner" style="width:{{writeup.rating|add:writeup.rating}}0%"></span></div>
                        <div class="main-entry-text">
                            {{writeup.review}}
                        </div>
                        <br/>
                        <p class="text-right"><sup><a href="#">Read More &raquo;</a></sup></p>
                    </div>
                </div>
                <hr>
            {% empty %}
                No one has reviewed this convention yet.
            {% endfor %}
            <p class="text-center">
                {{convention.writeups.count}} review{{convention.writeups.count|pluralize}} in total
                <br/><a href="/conreviews/{{convention.ID}}" class="btn btn-custom-blue">Read All Reviews</a>
            </p>
        </div>
        
        {% if currUser %}

            {% if currUser not in convention.users.all %}
                refresh the page to see it change, it does work.
                <button onclick="setFavorite()">mark as favorite convention</button>
            {% else %}
                <button onclick="unsetFavorite()">unmark as favorite convention</button>
            {% endif %}
        
            <div class="section-wrapper border-wrapper" id="add-review">
                {% if currUserConWriteup %}
                <a href="/writeup/{{currUserConWriteup.ID}}" class="btn btn-custom-blue">Edit Review</a>
                {% else %}
                    <h2 class="title-wrapper">Write Review</h2>
                    <div class="review-entry">
                        <div class="side-entry">
                            <img src="/static/images/icon-default.png" class="user-icon-large text-center"/>
                            <br/>{{currUser}}
                        </div>
                        <div class="main-entry">
                            Rating:
                            <span class="star-rating">
                                <input type="radio" name="ratingField" value="1"><i></i>
                                <input type="radio" name="ratingField" value="2"><i></i>
                                <input type="radio" name="ratingField" value="3"><i></i>
                                <input type="radio" name="ratingField" value="4"><i></i>
                                <input type="radio" name="ratingField" value="5"><i></i>
                            </span>
                            <br/>
                            <div class="form-group">
                                <textarea class="form-control" rows="5" id="reviewField"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="right">
                        <button onclick="makeWriteup()" class="btn btn-custom-blue" href="#">Submit</button>
                    </div>
                {% endif %}
            </div>
        {% endif %}

    </div>

  <!--  {% if currUser %}
        {% if currUserConWriteup %}
            <a href="/writeup/{{currUserConWriteup.ID}}">View or edit your writeup!</a>
        {% endif %}
        <br/>
        {% for item in currUserConItems %}
            <a href="/item/{{item.ID}}">Your item {{item}}</a>
            <br/>
        {% endfor %}
        <a href="/additem/{{convention.ID}}">Add an Item!</a>
        <br/>
        {% if convention.image %}
            <img src="{{convention.image}}"/>
            <br/>
        {% endif %}
        upload or replace the pic?
        <br/>
        <input type="file" id="fileField" accept="image/*"/> max 10 MiB
        <br/>
        <a onclick="uploadFile()" href="#">Submit</a>
    {% else %}
        {{convention.name}}'s Page
        <br/>
        {{convention.numAttenders}} attenders
        <br/>
        located at {{convention.location}}
        <br/>
        website at <a href="{{convention.website}}">{{convention.website}}</a>
        <br/>
        starts/started on {{convention.startDate}}
        <br/>
        ends/ended on {{convention.endDate}}
        <br/>
        {% if convention.image %}
            <img src="{{convention.image}}"/>
            <br/>
        {% endif %}
    {% endif %}-->

{% endblock %}
