{% extends "includes/helper.html" %}

{% block head %}
    {% if invEvent %}
        <title>ArtisTally | My Inventory</title>
    {% else %}
        <title>ArtisTally | My {{event.convention}} {{event}} Inventory</title>
    {% endif %}
    
    <script src="/static/js/editablegrid/all_min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

    <script>
        {% if not invEvent %}
            {% if miscCost %}
                function updateMiscCost() {
                    var jsonDict = new Object();
                    jsonDict.miscCostID = "{{miscCost.ID}}";
                    jsonDict.name = $().val();
                    jsonDict.amount = $("#mcAmountField").val();
                    if (jsonDict.amount != $("#mcAmountField").prop("defaultValue")) {
                        $.ajax({
                            url: "/api/miscCost/setAmount",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("Could not set miscellaneous costs! \n Error - " + JSON.parse(response.responseText).error);
                            },
                        });
                    }
                }
            {% else %}
                function updateMiscCost() {
                    var jsonDict = new Object();
                    jsonDict.eventID = "{{event.ID}}";
                    jsonDict.amount = $("#mcAmountField").val();
                    $.ajax({
                        url: "/api/miscCost/newMiscCost",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set miscellaneous costs! \n Error - " + JSON.parse(response.responseText).error);
                        },
                    });
                }
            {% endif %}
            
            function copyInventory() {
                $("#copyInventoryButton").attr("disabled", true);
                var jsonDict = new Object();
                jsonDict.eventID = {{event.ID}};
                $.ajax({
                    url: "/api/event/copyInventory",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(jsonDict),
                    success: function(response) {
                        location.reload();
                    },
                    error: function(response) {
                        alert("Could not copy inventory! \n Error - " + JSON.parse(response.responseText).error);
                    },
                });
            }
        {% endif %}
        
        function roundDecimal(num) {
            return Math.round(num*100)/100;
        }
         
        function makeEditableGrid() {
            editableGrid = new EditableGrid("InventoryEditableGrid", 
                { sortIconUp: "/static/images/up.png", 
                sortIconDown: "/static/images/down.png",
                modelChanged: function(rowIdx, colIdx, oldValue, newValue, row) { updateItem(row.id, rowIdx, colIdx, newValue, oldValue); }});
        
            // we build and load the metadata in Javascript
            editableGrid.load({ metadata: [
                { name: "name", datatype: "string", editable: true },
                { name: "fandom", datatype: "string", editable: true },
                { name: "kind", datatype: "string", editable: true },
                { name: "price", datatype: "double($,2,dot,comma,1)", editable: true },
                { name: "cost", datatype: "double($,2,dot,comma,1)", editable: true },
                { name: "remaining", datatype: "integer(,-1,dot,comma,1)", editable: true },
                {% if not invEvent %}
                    { name: "sold", datatype: "integer(,-1,dot,comma,1)", editable: true },
                {% endif %}
                { name: "action", datatype: "html", editable: false }
            ]});
            
            editableGrid.setCellRenderer("action", new CellRenderer({render: function(cell, value) {
                var rowID = editableGrid.getRowId(cell.rowIndex);
                cell.innerHTML = '<a onclick="duplicateItem(' + rowID + ')" style="cursor:pointer"><i class="fa fa-clone"></i></a>';
                cell.innerHTML += '&nbsp;<a onclick="deleteItem(' + rowID + ')" style="cursor:pointer"><i class="fa fa-trash"></i></a>';
            }})); 
            
            editableGrid.attachToHTMLTable("inventory");
            editableGrid.renderGrid();
        }
         
        function appendAutoComplete() {
            fandomResults = [
                {% for fandom in fandoms %}
                    "{{fandom}}",
                {% endfor %}
            ];
            
            $("#new-fandom").autocomplete({
                source: fandomResults,
                open: function(){
                    $(".ui-autocomplete").append('<li class="ui-menu-item" data-toggle="modal" data-target="#fandomModal" aria-label="Add New">+ New Fandom</li>');
                },
                response: function(event, ui) {
                    if (ui.content.length === 0) {
                        $("#add-new-fandom").removeClass("hidden");
                    } else {
                        $("#add-new-fandom").addClass("hidden");
                    }
                }
            });
            
            kindResults = [
                {% for kind in kinds %}
                    "{{kind}}",
                {% endfor %}
            ];
            
            $("#new-kind").autocomplete({
                source: kindResults,
                open: function(){
                    $(".ui-autocomplete").append('<li class="ui-menu-item" data-toggle="modal" data-target="#kindModal" aria-label="Add New">+ New Kind</li>');
                },
                response: function(event, ui) {
                    if (ui.content.length === 0) {
                        $("#add-new-kind").removeClass("hidden");
                    } else {
                        $("#add-new-kind").addClass("hidden");
                    }
                }
            });
        }
         
        $(function() {
            // add editable grid
            makeEditableGrid();
            // make new fandom and new kinds in add new form searchable
            appendAutoComplete();
        });
        
        function makeNewItem() {
            makeItem($("#new-name").val(), 
                     "{{event.ID}}", 
                     $("#new-fandom").val(), 
                     $("#new-kind").val(), 
                     roundDecimal($("#new-price").val()), 
                     roundDecimal($("#new-cost").val()), 
                     $("#new-numLeft").val(), 
                     {% if invEvent %}
                        0);
                     {% else %}
                        $("#new-numSold").val());
                     {% endif %}
        }
         
        function duplicateItem(rowID) {
            var rowIndex = editableGrid.getRowIndex(rowID);
            makeItem(editableGrid.getValueAt(rowIndex, 0), 
                    "{{event.ID}}", 
                    editableGrid.getValueAt(rowIndex, 1), 
                    editableGrid.getValueAt(rowIndex, 2), 
                    editableGrid.getValueAt(rowIndex, 3), 
                    editableGrid.getValueAt(rowIndex, 4), 
                    editableGrid.getValueAt(rowIndex, 5), 
                    {% if invCon %}
                        0);
                    {% else %}
                       editableGrid.getValueAt(rowIndex, 6));
                    {% endif %}
        }
        
        function makeItem(itemName, eventID, itemFandom, itemKind, itemPrice, itemCost, itemNumLeft, itemNumSold) {
            
            var jsonDict = new Object();
            jsonDict.name = itemName;
            jsonDict.eventID = eventID;
            jsonDict.fandom = itemFandom;
            jsonDict.kind = itemKind;
            jsonDict.price = itemPrice;
            jsonDict.cost = itemCost;
            jsonDict.numLeft = itemNumLeft;
            jsonDict.numSold = itemNumSold;
            
            $.ajax({
                url: "/api/item/newItem",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    editableGrid.append(response.itemID, {"name": itemName, "fandom": itemFandom, "kind": itemKind, "price": itemPrice, "cost": itemCost, "remaining": itemNumLeft{% if not invEvent %}, "sold": itemNumSold{% endif %}}, true);
                    editableGrid.refreshGrid();
                },
                error: function(response) {
                    alert('Error: \n' + JSON.parse(response.responseText).error);
                },
            });
        }
        
        function updateItem(itemID, rowID, colID, newValue, oldValue) {
            var name = 0,
                fandom = 1,
                kind = 2,
                price = 3,
                cost = 4,
                numLeft = 5
                {% if not invEvent %}
                    , numSold = 6
                {% endif %};
            
            var jsonDict = new Object();
            jsonDict.itemID = itemID;
            
            switch(colID) {
                case name:
                    jsonDict.name = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setName",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new name! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case fandom:
                    jsonDict.fandom = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setFandom",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new fandom! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case kind:
                    jsonDict.kind = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setKind",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new kind! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case price:
                    jsonDict.price = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setPrice",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new price! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case cost:
                    jsonDict.cost = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setCost",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new cost! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case numLeft:
                    jsonDict.numLeft = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setNumLeft",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new number remaining! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                {% if not invEvent %}
                    case numSold:
                        jsonDict.numSold = newValue;
                        var ajaxObj = $.ajax({
                            url: "/api/item/setNumSold",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            error: function(response) {
                                alert("Could not set new number sold! \n Error - " + JSON.parse(response.responseText).error);
                                editableGrid.setValueAt(rowID, colID, oldValue, true);
                            },
                        });
                        break;
                {% endif %}
            }
        }
        
        function deleteItem(itemID) {
            if (confirm("Are you sure you want to delete this?")) {
                var jsonDict = new Object();
                jsonDict.itemID = itemID;
                var ajaxObj = $.ajax({
                    url: "/api/item/deleteItem",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(jsonDict),
                    success: function(response) {
                        //$("#" + itemID + "nameField").closest("tr").remove();
                        var rowIndex = editableGrid.getRowIndex(itemID);
                        editableGrid.remove(rowIndex);
                        //editableGrid.remove();
                        // Editable Grid shuffles everything inside the tr but not the tr itself... so the IDs don't match up
                    },
                    error: function(response) {
                        alert("Could not delete item! \n Error - " + JSON.parse(response.responseText).error);
                    },
                });
            }
        }
                    
        function toggleItemForm() {
            {% if invEvent %}
                var buttonStr = "#new-numLeft";
            {% else %}
                var buttonStr = "#new-numSold";
            {% endif %}
            if ($("#item-form").css("display") == "none") {
                $("#item-form").show("slow", function() {});
                var KEYUP = function(event) {
                    if (event.keyCode == 13) {
                        $("#add-item").click();
                    }
                }
                $(buttonStr).keyup(KEYUP);
            } else {
                $("#item-form").hide("slow", function() {});
                $(buttonStr).unbind("keyup", KEYUP);
            }
        }
        
        function makeFandom() {
            var jsonDict = new Object();
            jsonDict.name = $("#fandomField").val();
            console.log(jsonDict.name);
            $.ajax({
                url: "/api/fandom/newFandom",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    fandomResults.push(jsonDict.name);
                    $("#fandomModal").modal("hide");
                    $("#new-fandom").val(jsonDict.name);
                    $("#add-new-fandom").addClass("hidden");
                },
                error: function(response) {
                    alert("Could not make new fandom! \n Error - " + JSON.parse(response.responseText).error);
                },
            });
        }
        
        function makeKind() {
            var jsonDict = new Object();
            jsonDict.name = $("#kindField").val();
            console.log(jsonDict.name);
            $.ajax({
                url: "/api/kind/newKind",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    kindResults.push(jsonDict.name);
                    $("#kindModal").modal("hide");
                    $("#new-kind").val(jsonDict.name);
                    $("#add-new-kind").addClass("hidden");
                },
                error: function(response) {
                    alert("Could not set new kind! \n Error - " + JSON.parse(response.responseText).error);
                },
            });
        }
    </script>
{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">
            <div class="col-md-2 sidebar">
                <div class="fixed">
                    {% include "includes/sidebar.html" %}
                </div>
            </div>

            <div class="col-md-10">
                <div class="my-section-wrapper border-wrapper">
                    <h1 class="title-wrapper">{% if not invEvent %}{{event.convention}} {{event}} {% endif %}Inventory</h1>
                    <div id="inventory-page">
                        Click cell to edit.
                        <br/>
                        <br/>
                    <div>
                        {% if not invEvent %}
                            <a onclick="copyInventory()" id="copyInventoryButton" class="btn btn-custom-blue">Copy Main Inventory</a>
                        {% endif %}
                        <a onclick="toggleItemForm()" class="btn btn-custom-blue"><i class="fa fa-plus-circle fa-1x"></i> Add Item</a>
                        <div id="item-form">
                            <br/>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label class="control-label required" for="new-name">Name:</label>
                                        <input type="text" class="form-control" placeholder="Name" id="new-name" autocomplete="off">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-fandom">Fandom:</label><small class="hidden" id="add-new-fandom">&nbsp;&nbsp;&nbsp;Fandom not found. <a data-toggle="modal" data-target="#fandomModal" aria-label="Add New" style="cursor:pointer">Add new fandom?</a></small>
                                        <input type="text" class="form-control" placeholder="Pokemon, Hunter x Hunter, etc..." id="new-fandom">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-kind">Kind:</label><small class="hidden" id="add-new-kind">&nbsp;&nbsp;&nbsp;Kind not found. <a data-toggle="modal" data-target="#kindModal" aria-label="Add New" style="cursor:pointer">Add new kind?</a></small>
                                        <input type="text" class="form-control" placeholder="Acrylic keychain, print, etc..." id="new-kind">
                                        <div id="add-new-kind"></div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label class="control-label required" for="new-price">Price:</label>
                                        <input type="text" class="form-control" placeholder="0" id="new-price">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-cost">Cost:</label>
                                        <input type="text" class="form-control" placeholder="0" id="new-cost" autocomplete="off">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-numLeft">In Stock:</label>
                                        <input type="text" class="form-control" placeholder="0" id="new-numLeft" autocomplete="off">
                                    </div>
                                    {% if not invEvent %}
                                        <div class="form-group">
                                            <label class="control-label required" for="new-numSold">Sold:</label>
                                            <input type="text" class="form-control" placeholder="0" id="new-numSold" autocomplete="off">
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="text-center"><a onclick="makeNewItem()" class="btn btn-custom-blue" id="add-item">Add Item</a></p> 
                            <hr>
                        </div>
                    </div>

                    <table class="table table-hover" id="inventory">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Fandom</th>
                                <th>Kind</th>
                                <th>Price</th>
                                <th>Cost</th>
                                <th>In Stock</th>
                                {% if not invEvent %}
                                    <th>Sold</th>
                                {% endif %}
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                        {% for item in eventItems %}
                            <tr id="{{item.ID}}">
                                <td>{{item.name}}</td>
                                <td>{{item.fandom}}</td>
                                <td>{{item.kind}}</td>
                                <td>{{item.price|floatformat:2}}</td>
                                <td>{{item.cost|floatformat:2}}</td>
                                <td>{{item.numLeft}}</td>
                                {% if not invEvent %}
                                    <td>{{item.numSold}}</td>
                                {% endif %}
                                <td></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% if not invEvent %}
                        <br/>
                        {% for mc in miscCosts %}
                            <div class="form-group">
                                <label for="mc{{mc.ID}}AmountField">Miscellaneous Costs:</label>
                                <br/>
                                Table, transportation, hotel, printing costs, etc...
                                Misc costs <input type="number" class="form-control" min="0" step="0.01" id="mc{{mc.ID}}AmountField" placeholder="0.00" {% if mc %} value="{{mc.amount}}" {% endif %}/>
                                Name of misc cost, what was it for <input type="text" class="form-control" id="mc{{md.ID}}NameField" placeholder="hookers" {% if mc %} value="{{mc.name}}" {% endif %}/>
                            </div>
                            <br/>
                        {% endfor %}
                        <div class="form-group">
                            <label for="mcAmountField">Make a new one:</label>
                            <br/>
                            Table, transportation, hotel, printing costs, etc...
                            Misc costs <input type="number" class="form-control" min="0" step="0.01" id="mcAmountField" placeholder="0.00"/>
                            Name of misc cost, what was it for <input type="text" class="form-control" id="mcNameField" placeholder="hookers"/>
                        </div>
                        <br/>
                        <a class="btn btn-custom-blue" onclick="updateMiscCost()" href="#">TODO update misccost</a>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% include "includes/modals.html" %}
{% endblock %}
