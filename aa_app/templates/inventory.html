{% extends "includes/helper.html" %}

{% block head %}
    {% if invCon %}
        <title>ArtisTally | My Inventory</title>
    {% else %}
        <title>ArtisTally | My {{convention}} Inventory</title>
    {% endif %}

    <script type="text/javascript" src="/static/js/editablegrid/all_min.js"></script>

    <script>
        function findFandom() {
            var jsonDict = new Object();
            jsonDict.query = "test"
            $.ajax({
                url: "/api/search/findFandom",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    console.log(response.results)
                },
                error: function(response) {
                    alert("findFandom went wrong");
                },
            });
        }
        
        function findKind() {
            var jsonDict = new Object();
            jsonDict.query = "test"
            $.ajax({
                url: "/api/search/findKind",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    console.log(response.results)
                },
                error: function(response) {
                    alert("findKind went wrong");
                },
            });
        }
        
        function makeItem() {
            var itemName, itemFandom, itemKind, itemPrice, itemCost, itemNumLeft;
            
            var jsonDict = new Object();
            jsonDict.name = itemName = $("#new-name").val();
            jsonDict.conID = {{convention.ID}};
            jsonDict.fandom = itemFandom = $("#new-fandom").val();
            jsonDict.kind = itemKind = $("#new-kind").val();
            jsonDict.price = itemPrice = $("#new-price").val();
            jsonDict.cost = itemCost = $("#new-cost").val();
            jsonDict.numLeft = itemNumLeft = $("#new-numLeft").val();
            {% if invCon %}
                jsonDict.numSold = 0;
            {% else %}
                jsonDict.numSold = itemNumSold = $("#new-numSold").val();
            {% endif %}
            
            $.ajax({
                url: "/api/item/newItem",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    $('#inventory tr:last').after("<tr id='" + response.itemID + "'>" +
                        "<td>Icon</td>" +
                        "<td id='" + response.itemID + "nameField'>" + itemName + "</td>" +
                        "<td id='" + response.itemID + "fandomField'>" + itemFandom + "</td>" +
                        "<td id='" + response.itemID + "kindField'>" + itemKind + "</td>" +
                        "<td id='" + response.itemID + "priceField'>" + itemPrice + "</td>" +
                        "<td id='" + response.itemID + "costField'>" + itemCost + "</td>" +
                        "<td id='" + response.itemID + "numLeftField'>" + itemNumLeft + "</td>" +
                        {% if not invCon %}
                        "<td id='" + response.itemID + "numSoldField'>" + itemNumSold + "</td>" +
                        {% endif %}
                        "<td><a onclick='deleteItem(" + response.itemID + ")' style='cursor:pointer'><i class='fa fa-trash'></i></a></td>" +
                    "</tr>");
                    editableGrid.refreshGrid();
                },
                error: function(response) {
                    alert("newItem went wrong");
                },
            });
        }
        
        function updateItem(itemID, rowID, colID, newValue, oldValue) {
            var name = 1,
                fandom = 2,
                kind = 3,
                price = 4,
                cost = 5,
                numLeft = 6
                {% if not invCon %}
                    ,numSold = 7
                {% endif %};
            
            var jsonDict = new Object();
            jsonDict.itemID = itemID;
            
            switch(colID) {
                case name:
                    jsonDict.name = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setName",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setName went wrong");
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case fandom:
                    jsonDict.fandom = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setFandom",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setFandom went wrong");
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case kind:
                    jsonDict.kind = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setKind",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setKind went wrong");
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case price:
                    jsonDict.price = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setPrice",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setPrice went wrong");
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case cost:
                    jsonDict.cost = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setCost",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setCost went wrong");
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case numLeft:
                    jsonDict.numLeft = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setNumLeft",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("setNumLeft went wrong");
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                {% if not invCon %}
                    case numLeft:
                        jsonDict.numSold = newValue;
                        var ajaxObj = $.ajax({
                            url: "/api/item/setNumSold",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            error: function(response) {
                                alert("setNumSold went wrong");
                                editableGrid.setValueAt(rowID, colID, oldValue, true);
                            },
                        });
                        break;
                {% endif %}
            }
        }
        
        function deleteItem(itemID) {
            if (confirm("Are you sure you want to delete this?")) {
                var jsonDict = new Object();
                jsonDict.itemID = itemID;
                var ajaxObj = $.ajax({
                    url: "/api/item/deleteItem",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(jsonDict),
                    success: function(response) {
                        $("#" + itemID + "nameField").closest("tr").remove(); 
                        // Editable Grid shuffles everything inside the tr but not the tr itself... so the IDs don't match up
                    },
                    error: function(response) {
                        alert("deleteItem went wrong");
                    },
                });
            }
        }
        
        function toggleItemForm() {
            if ($("#item-form").css("display") == "none") {
                $("#item-form").show("slow", function() {});
            } else {
                $("#item-form").hide("slow", function() {});
            }
        }
        
        window.onload = function() {
            editableGrid = new EditableGrid("InventoryEditableGrid", 
                { sortIconUp: "/static/images/up.png", 
                sortIconDown: "/static/images/down.png",
                // called when some value has been modified: we display a message
                // row.id to get ID
                modelChanged: function(rowIdx, colIdx, oldValue, newValue, row) { updateItem(row.id, rowIdx, colIdx, newValue, oldValue); }});
        
            // we build and load the metadata in Javascript
            editableGrid.load({ metadata: [
                { name: "thumbnail", datatype: "string", editable: false },
                { name: "name", datatype: "string", editable: true },
                { name: "fandom", datatype: "string", editable: true },
                { name: "kind", datatype: "string", editable: true },
                { name: "price", datatype: "double", editable: true },
                { name: "cost", datatype: "double", editable: true },
                { name: "remaining", datatype: "integer", editable: true }
                {% if not invCon %}
                    ,{ name: "sold", datatype: "integer", editable: true }
                {% endif %}
            ]});

            // then we attach to the HTML table and render it
            editableGrid.attachToHTMLTable("inventory");
            //editableGrid.setPageSize(5);
            editableGrid.renderGrid();
        }
        
        function makeFandom() {
            var jsonDict = new Object();
            jsonDict.name = $("#fandomField").val();
            console.log(jsonDict.name);
            $.ajax({
                url: "/api/fandom/newFandom",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    location.reload();
                },
                error: function(response) {
                    alert("newKind went wrong");
                },
            });
        }
        
        function makeKind() {
            var jsonDict = new Object();
            jsonDict.name = $("#kindField").val();
            console.log(jsonDict.name);
            $.ajax({
                url: "/api/kind/newKind",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    location.reload();
                },
                error: function(response) {
                    alert("newKind went wrong");
                },
            });
        }
        
    </script>
{% endblock %}

{% block body %}
    <div class="row">
        <div class="col-sm-2 sidebar">
            <div class="fixed">
                {% include "includes/sidebar.html" %}
            </div>
        </div>

        <div class="col-sm-10 maincontent-wrapper">
            <div id="inventory-page">
            <h1>{% if not invCon %}{{convention}} {% endif %}Inventory</h1>
                
            <div>
                <button onclick="toggleItemForm()" class="btn btn-custom-blue"><i class="fa fa-plus-circle fa-1x"></i> Add Item</button>
                <div id="item-form">
                    <label class="control-label">Preview Image:</label>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label col-sm-2" for="new-name">Name:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" placeholder="Name" id="new-name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-sm-2" for="new-fandom">Fandom:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" placeholder="Fandom" id="new-fandom">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-sm-2" for="new-kind">Kind:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" placeholder="Kind" id="new-kind">
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label col-sm-2" for="new-price">Price:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" placeholder="Price" id="new-price">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-sm-2" for="new-cost">Cost:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" placeholder="Cost" id="new-cost">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-sm-2" for="new-numLeft">Remaining:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" placeholder="Remaining" id="new-numLeft">
                                </div>
                            </div>
                            {% if not invCon %}
                                <div class="form-group">
                                    <label class="control-label col-sm-2" for="new-numSold">Sold:</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" placeholder="Sold" id="new-numSold">
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <a onclick="makeItem()" class="btn btn-custom-blue">Add</a>
                    <br/>
                    <a class="btn btn-custom-blue btn-lg" data-toggle="modal" data-target="#fandomModal">Add Fandom</a>
                    <br/>
                    <a class="btn btn-custom-blue btn-lg" data-toggle="modal" data-target="#kindModal">Add Kind</a>
                </div>
            </div>

            <table class="table table-hover" id="inventory">
                <thead>
                    <tr>
                        <th>Thumbnail</th>
                        <th>Name</th>
                        <th>Fandom</th>
                        <th>Kind</th>
                        <th>Price</th>
                        <th>Cost</th>
                        <th>Remaining</th>
                        {% if not invCon %}
                            <th>Sold</th>
                        {% endif %}
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="inventory-body">
                {% for item in conItems %}
                    <tr id="{{item.ID}}">
                        <td>Icon</td>
                        <td id="{{item.ID}}nameField">{{item.name}}</td>
                        <td id="{{item.ID}}fandomField">{{item.fandom}}</td>
                        <td id="{{item.ID}}kindField">{{item.kind}}</td>
                        <td id="{{item.ID}}priceField">{{item.price|floatformat:2}}</td>
                        <td id="{{item.ID}}costField">{{item.cost|floatformat:2}}</td>
                        <td id="{{item.ID}}numLeftField">{{item.numLeft}}</td>
                        {% if not invCon %}
                            <td id="{{item.ID}}numSoldField">{{item.numSold}}</td>
                        {% endif %}
                        <td><a onclick="deleteItem({{item.ID}})" style="cursor:pointer"><i class="fa fa-trash"></i></a></td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
    </div>
{% include "includes/modals.html" %}
{% endblock %}
