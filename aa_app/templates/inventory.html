{% extends "includes/helper.html" %}

{% block head %}
    {% if invCon %}
        <title>ArtisTally | My Inventory</title>
    {% else %}
        <title>ArtisTally | My {{convention}} Inventory</title>
    {% endif %}
    
    <script src="/static/js/editablegrid/all_min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script>
        {% if not invCon %}
            {% if miscCost %}
                function updateMiscCost() {
                    var jsonDict = new Object();
                    jsonDict.miscCostID = "{{miscCost.ID}}";
                    jsonDict.amount = $("#miscCostsField").val();
                    if (jsonDict.amount != $("#miscCostsField").prop("defaultValue")) {
                        $.ajax({
                            url: "/api/miscCost/setAmount",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("Could not set miscellaneous costs! \n Error - " + JSON.parse(response.responseText).error);
                            },
                        });
                    }
                }
            {% else %}
                function updateMiscCost() {
                    var jsonDict = new Object();
                    jsonDict.conID = "{{convention.ID}}";
                    jsonDict.amount = $("#miscCostsField").val();
                    $.ajax({
                        url: "/api/miscCost/newMiscCost",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set miscellaneous costs! \n Error - " + JSON.parse(response.responseText).error);
                        },
                    });
                }
            {% endif %}
        {% endif %}
        
        function makeNewItem() {
            makeItem($("#new-name").val(), 
                     "{{convention.ID}}", 
                     $("#new-fandom").val(), 
                     $("#new-kind").val(), 
                     $("#new-price").val(), 
                     $("#new-cost").val(), 
                     $("#new-numLeft").val(), 
                     {% if invCon %}
                        0);
                     {% else %}
                        $("#new-numSold").val());
                     {% endif %}
        }
         
        function duplicateItem(itemID) {
            makeItem($("#" + itemID + "nameField").html(), 
                    "{{convention.ID}}", 
                    $("#" + itemID + "fandomField").html(), 
                    $("#" + itemID + "kindField").html(), 
                    $("#" + itemID + "priceField").html(), 
                    $("#" + itemID + "costField").html(), 
                    $("#" + itemID + "numLeftField").html(), 
                    {% if invCon %}
                        0);
                    {% else %}
                        $("#" + itemID + "numSoldField").html());
                    {% endif %}
        }
        
        function makeItem(itemName, conID, itemFandom, itemKind, itemPrice, itemCost, itemNumLeft, itemNumSold) {
            
            var jsonDict = new Object();
            jsonDict.name = itemName;
            jsonDict.conID = conID;
            jsonDict.fandom = itemFandom;
            jsonDict.kind = itemKind;
            jsonDict.price = itemPrice;
            jsonDict.cost = itemCost;
            jsonDict.numLeft = itemNumLeft;
            jsonDict.numSold = itemNumSold;
            
            $.ajax({
                url: "/api/item/newItem",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    $('#inventory tr:last').after("<tr id='" + response.itemID + "'>" +
                        "<td id='" + response.itemID + "nameField'>" + itemName + "</td>" +
                        "<td id='" + response.itemID + "fandomField'>" + itemFandom + "</td>" +
                        "<td id='" + response.itemID + "kindField'>" + itemKind + "</td>" +
                        "<td id='" + response.itemID + "priceField'>" + itemPrice + "</td>" +
                        "<td id='" + response.itemID + "costField'>" + itemCost + "</td>" +
                        "<td id='" + response.itemID + "numLeftField'>" + itemNumLeft + "</td>" +
                        {% if not invCon %}
                        "<td id='" + response.itemID + "numSoldField'>" + itemNumSold + "</td>" +
                        {% endif %}
                        "<td><a onclick='duplicateItem(" + response.itemID + ")' style='cursor:pointer'><i class='fa fa-clone'></i></a>" +
                        " <a onclick='deleteItem(" + response.itemID + ")' style='cursor:pointer'><i class='fa fa-trash'></i></a></td>" +
                    "</tr>");
                    editableGrid.refreshGrid();
                },
                error: function(response) {
                    alert('Error: \n' + JSON.parse(response.responseText).error);
                },
            });
        }
        
        function updateItem(itemID, rowID, colID, newValue, oldValue) {
            var name = 0,
                fandom = 1,
                kind = 2,
                price = 3,
                cost = 4,
                numLeft = 5
                {% if not invCon %}
                    , numSold = 6
                {% endif %};
            
            var jsonDict = new Object();
            jsonDict.itemID = itemID;
            
            switch(colID) {
                case name:
                    jsonDict.name = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setName",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new name! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case fandom:
                    jsonDict.fandom = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setFandom",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new fandom! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case kind:
                    jsonDict.kind = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setKind",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new kind! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case price:
                    jsonDict.price = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setPrice",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new price! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case cost:
                    jsonDict.cost = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setCost",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new cost! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                case numLeft:
                    jsonDict.numLeft = newValue;
                    var ajaxObj = $.ajax({
                        url: "/api/item/setNumLeft",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        error: function(response) {
                            alert("Could not set new number remaining! \n Error - " + JSON.parse(response.responseText).error);
                            editableGrid.setValueAt(rowID, colID, oldValue, true);
                        },
                    });
                    break;
                {% if not invCon %}
                    case numSold:
                        jsonDict.numSold = newValue;
                        var ajaxObj = $.ajax({
                            url: "/api/item/setNumSold",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            error: function(response) {
                                alert("Could not set new number sold! \n Error - " + JSON.parse(response.responseText).error);
                                editableGrid.setValueAt(rowID, colID, oldValue, true);
                            },
                        });
                        break;
                {% endif %}
            }
        }
        
        function deleteItem(itemID) {
            if (confirm("Are you sure you want to delete this?")) {
                var jsonDict = new Object();
                jsonDict.itemID = itemID;
                var ajaxObj = $.ajax({
                    url: "/api/item/deleteItem",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(jsonDict),
                    success: function(response) {
                        $("#" + itemID + "nameField").closest("tr").remove();
                        // Editable Grid shuffles everything inside the tr but not the tr itself... so the IDs don't match up
                    },
                    error: function(response) {
                        alert("Could not delete item! \n Error - " + JSON.parse(response.responseText).error);
                    },
                });
            }
        }
                    
        function toggleItemForm() {
            {% if invCon %}
                var buttonStr = "#new-numLeft";
            {% else %}
                var buttonStr = "#new-numSold";
            {% endif %}
            if ($("#item-form").css("display") == "none") {
                $("#item-form").show("slow", function() {});
                var KEYUP = function(event) {
                    if (event.keyCode == 13) {
                        $("#add-item").click();
                    }
                }
                $(buttonStr).keyup(KEYUP);
            } else {
                $("#item-form").hide("slow", function() {});
                $(buttonStr).unbind("keyup", KEYUP);
            }
        }
        
        function makeFandom() {
            var jsonDict = new Object();
            jsonDict.name = $("#fandomField").val();
            console.log(jsonDict.name);
            $.ajax({
                url: "/api/fandom/newFandom",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    location.reload();
                },
                error: function(response) {
                    alert("Could not make new fandom! \n Error - " + JSON.parse(response.responseText).error);
                },
            });
        }
        
        function makeKind() {
            var jsonDict = new Object();
            jsonDict.name = $("#kindField").val();
            console.log(jsonDict.name);
            $.ajax({
                url: "/api/kind/newKind",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    location.reload();
                },
                error: function(response) {
                    alert("Could not set new kind! \n Error - " + JSON.parse(response.responseText).error);
                },
            });
        }
             
        function copyInventory() {
            $("#copyInventoryButton").attr("disabled", true);
            var jsonDict = new Object();
            jsonDict.conID = {{convention.ID}};
            $.ajax({
                url: "/api/convention/copyInventory",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(jsonDict),
                success: function(response) {
                    location.reload();
                },
                error: function(response) {
                    alert("Could not copy inventory! \n Error - " + JSON.parse(response.responseText).error);
                },
            });
        }
                    
        function makeEditableGrid() {
            editableGrid = new EditableGrid("InventoryEditableGrid", 
                { sortIconUp: "/static/images/up.png", 
                sortIconDown: "/static/images/down.png",
                // called when some value has been modified: we display a message
                // row.id to get ID
                modelChanged: function(rowIdx, colIdx, oldValue, newValue, row) { updateItem(row.id, rowIdx, colIdx, newValue, oldValue); }});
        
            // we build and load the metadata in Javascript
            editableGrid.load({ metadata: [
                { name: "name", datatype: "string", editable: true },
                { name: "fandom", datatype: "string", editable: true },
                { name: "kind", datatype: "string", editable: true },
                { name: "price", datatype: "double", editable: true },
                { name: "cost", datatype: "double", editable: true },
                { name: "remaining", datatype: "integer", editable: true }
                {% if not invCon %}
                    ,{ name: "sold", datatype: "integer", editable: true }
                {% endif %}
            ]});

            // then we attach to the HTML table and render it
            editableGrid.attachToHTMLTable("inventory");
            //editableGrid.setPageSize(5);
            editableGrid.renderGrid();
        }
        
        function appendAutoComplete() {
            var kindsResults = [
                {% for kind in kinds %}
                    "{{kind}}",
                {% endfor %}
            ];
            var fandomResults = [
                {% for fandom in fandoms %}
                    "{{fandom}}",
                {% endfor %} 
            ];
            
            $("#new-fandom").autocomplete({
                source: fandomResults
            });
            $("#new-kind").autocomplete({
                source: kindsResults
            });
            
            $("#new-fandom").autocomplete({
                open: function(){
                    $(".ui-autocomplete").append('<li class="ui-menu-item" data-toggle="modal" data-target="#fandomModal" aria-label="Add New"><i class="fa fa-plus"></i> Add New</li>');
                }
            });
            
            $("#new-kind").autocomplete({
                open: function(){
                    $(".ui-autocomplete").append('<li class="ui-menu-item" data-toggle="modal" data-target="#kindModal" aria-label="Add New"><i class="fa fa-plus"></i> Add New</li>');
                }
            });
        }
        
        $(function() {
            // add editable grid
            makeEditableGrid();
            // make new fandom and new kinds in add new form searchable
            appendAutoComplete();
        });
        
    </script>
{% endblock %}

{% block body %}
    <div class="container">
        <div class="row">
            <div class="col-md-2 sidebar">
                <div class="fixed">
                    {% include "includes/sidebar.html" %}
                </div>
            </div>

            <div class="col-md-10">
                <div class="my-section-wrapper border-wrapper">
                    <h1 class="title-wrapper">{% if not invCon %}{{convention}} {% endif %}Inventory</h1>
                    <div id="inventory-page">
                    <div>
                        {% if not invCon %}
                            <a onclick="copyInventory()" id="copyInventoryButton" class="btn btn-custom-blue">Copy Main Inventory</a>
                        {% endif %}
                        <a onclick="toggleItemForm()" class="btn btn-custom-blue"><i class="fa fa-plus-circle fa-1x"></i> Add Item</a>
                        <div id="item-form">
                            <br/>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label class="control-label required" for="new-name">Name:</label>
                                        <input type="text" class="form-control" placeholder="Name" id="new-name" autocomplete="off">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-fandom">Fandom:</label>
                                        <input type="text" class="form-control" placeholder="Pokemon, Hunter x Hunter, etc..." id="new-fandom">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-kind">Kind:</label>
                                        <input type="text" class="form-control" placeholder="Acrylic keychain, print, etc..." id="new-kind">
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label class="control-label required" for="new-price">Price:</label>
                                        <input type="text" class="form-control" placeholder="0" id="new-price">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-cost">Cost:</label>
                                        <input type="text" class="form-control" placeholder="0" id="new-cost" autocomplete="off">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label required" for="new-numLeft">In Stock:</label>
                                        <input type="text" class="form-control" placeholder="0" id="new-numLeft" autocomplete="off">
                                    </div>
                                    {% if not invCon %}
                                        <div class="form-group">
                                            <label class="control-label required" for="new-numSold">Sold:</label>
                                            <input type="text" class="form-control" placeholder="0" id="new-numSold" autocomplete="off">
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="text-center"><a onclick="makeNewItem()" class="btn btn-custom-blue" id="add-item">Add Item</a></p> 
                            <hr>
                        </div>
                    </div>

                    <table class="table table-hover" id="inventory">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Fandom</th>
                                <th>Kind</th>
                                <th>Price</th>
                                <th>Cost</th>
                                <th>In Stock</th>
                                {% if not invCon %}
                                    <th>Sold</th>
                                {% endif %}
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                        {% for item in conItems %}
                            <tr id="{{item.ID}}">
                                <td id="{{item.ID}}nameField">{{item.name}}</td>
                                <td id="{{item.ID}}fandomField">{{item.fandom}}</td>
                                <td id="{{item.ID}}kindField">{{item.kind}}</td>
                                <td id="{{item.ID}}priceField">{{item.price|floatformat:2}}</td>
                                <td id="{{item.ID}}costField">{{item.cost|floatformat:2}}</td>
                                <td id="{{item.ID}}numLeftField">{{item.numLeft}}</td>
                                {% if not invCon %}
                                    <td id="{{item.ID}}numSoldField">{{item.numSold}}</td>
                                {% endif %}
                                <td>
                                    <a onclick="duplicateItem({{item.ID}})" style="cursor:pointer"><i class="fa fa-clone"></i></a>
                                    <a onclick="deleteItem({{item.ID}})" style="cursor:pointer"><i class="fa fa-trash"></i></a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    {% if not invCon %}
                        <br/>
                        <div class="form-group">
                            <label for="miscCostsField">Miscellaneous Costs:</label>
                            Misc costs <input type="number" class="form-control" min="0" step="0.01" id="miscCostsField" placeholder="0.00" {% if miscCost %} value="{{miscCost}}" {% endif %}/>
                        </div>
                        <br/>
                        <a class="btn btn-custom-blue" onclick="updateMiscCost()" href="#">update misccost</a>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% include "includes/modals.html" %}
{% endblock %}
