{% extends "includes/helper.html" %}

{% block head %}
    <title>Artistally Writeup by {{writeup.user}} about {{writeup.convention}}</title>
    {% if currUser and currUser == writeup.user %}
        <script>
            $(function() {
             //check correct review radio button
                $("#r" + {{writeup.rating}}).attr("checked", true);
                console.log({{writeup.rating}});
            });
            
            function updateMiscCost() {
                var jsonDict = new Object();
                jsonDict.miscCostID = {{miscCost.ID}};
                jsonDict.amount = $("#miscCostsField").val();
                if (jsonDict.amount != $("#miscCostsField").prop("defaultValue")) {
                    $.ajax({
                        url: "/api/miscCost/setAmount",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        async: false,
                        error: function(response) {
                            alert("setAmount went wrong");
                        },
                    });
                }
            }
            
            function updateWriteup() {
                var jsonDict = new Object();
                jsonDict.writeupID = {{writeup.ID}};
                jsonDict.rating = $("#ratingField").val();
                jsonDict.review = $("#reviewField").val();
                jsonDict.miscCosts = $("#miscCostsField").val();
                if (jsonDict.rating != $("#ratingField").prop("defaultValue")) {
                    var ajaxObj = $.ajax({
                        url: "/api/writeup/setRating",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        async: false,
                        error: function(response) {
                            alert("setRating went wrong");
                        },
                    });
                    if (ajaxObj.status != 200) {
                        return false;
                    }
                }
                if (jsonDict.review != $("#reviewField").prop("defaultValue")) {
                    var ajaxObj = $.ajax({
                        url: "/api/writeup/setReview",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        async: false,
                        error: function(response) {
                            alert("setReview went wrong");
                        },
                    });
                    if (ajaxObj.status != 200) {
                        return false;
                    }
                }
                if (jsonDict.miscCosts != $("#miscCostsField").prop("defaultValue")) {
                    var ajaxObj = $.ajax({
                        url: "/api/writeup/setMiscCosts",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        async: false,
                        error: function(response) {
                            alert("setMiscCosts went wrong");
                        },
                    });
                    if (ajaxObj.status != 200) {
                        return false;
                    }
                }
                window.location.reload(true);
            }
        </script>
    {% endif %}
{% endblock %}

{% block body %}

<div class="container">
    <!--=============== HEADER =============-->
    <div class="jumbotron-convention">
    </div>
    
    <h1 class="text-center">Edit your review for <b>{{convention}}</b></h1>
    

    <!-- ========== ENTRY ============ -->
    {% if currUser and currUser == writeup.user %}
    <div class="review-entry">
        <div class="side cell">
            <img src="/static/images/icon-default.png" class="user-icon-large">
            <br/><b>{{currUser}}</b>
            <br/>{{writeup.editTime|date:"M d, Y"}}
            {% if writeup.editTime.timestamp > writeup.writeTime.timestamp|add:1 %}
        <br/> Last edit {{writeup.editTime|date:"M d, Y"}}
        {% endif %}
        </div>
        <div class="main cell">
             Rating:
            <span class="star-rating">
                <input type="radio" name="ratingField" id="r1" value="1"><i></i>
                <input type="radio" name="ratingField" id="r2" value="2"><i></i>
                <input type="radio" name="ratingField" id="r3" value="3"><i></i>
                <input type="radio" name="ratingField" id="r4" value="4"><i></i>
                <input type="radio" name="ratingField" id="r5" value="5"><i></i>
            </span>
            <br/>
            <textarea rows="5" id="reviewField">{{writeup.review}}</textarea>
            <button onclick="makeWriteup()" class="btn btn-custom-blue">Update</button>
        </div>
    </div>
    {% else %}
    
    <!-- ============ 404 page ============-->
    
    {% endif %}
<!--
    
    
    written on {{writeup.writeTime.isoformat}}
    {% if writeup.editTime.timestamp > writeup.writeTime.timestamp|add:1 %}
        <br/>
        last edited on {{writeup.editTime.isoformat}}
    {% endif %}
    <br/>
    {% if currUser and currUser == writeup.user %}
        rated <input type="number" min="0" max="5" id="ratingField" value="{{writeup.rating}}"/> stars
        <br/>
        Misc costs (travel etc) $<input type="number" min="0" step="0.01" id="miscCostsField" value="{{miscCost}}"/>
        <br/>
        <textarea rows="5" id="reviewField">{{writeup.review}}</textarea>
        <br/>
        <a onclick="updateWriteup()" href="#">Submit</a>
    {% else %}
        rated {{writeup.rating}} stars
        <br/>
        Misc costs (travel etc) ${{miscCost|floatformat:2}}
        <br/>
        review: <textarea rows="5" readonly>{{writeup.review}}</textarea>
    {% endif %}
</div>
{% endblock %}
-->
