{% extends "includes/helper.html" %}

{% block head %}
    <title>Artistally User {{pageUser}}</title>
    {% if currUser and currUser == pageUser %}
        <script>
            function uploadFile() {
                var file = document.getElementById("fileField").files[0];
                var reader = new FileReader();
                reader.onloadend = function() {
                    var jsonDict = new Object();
                    jsonDict.file = reader.result.split(",")[1];
                    $.ajax({
                        url: "/api/util/uploadFile",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        success: function(response) {
                            updateImage(response.url);
                        },
                        error: function(response) {
                            alert("uploadFile went wrong");
                        },
                    });
                }
                if (file) {
                    reader.readAsDataURL(file);
                }
            }
            
            function updateImage(url) {
                var jsonDict = new Object();
                jsonDict.image = url;
                var ajaxObj = $.ajax({
                    url: "/api/user/setImage",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(jsonDict),
                    async: false,
                    error: function(response) {
                        alert("setImage went wrong");
                    },
                });
                if (ajaxObj.status == 200) {
                    window.location.reload(true);
                }
            }
            
            function updateProfile() {
                var jsonDict = new Object();
                jsonDict.startYear = $("#startYearField").val();
                jsonDict.email = $("#emailField").val();
                jsonDict.password = $("#passField1").val();
                jsonDict.oldPassword = $("#oldPassField").val();
                if (jsonDict.password != $("#passField2").val()) {
                    alert("Your passwords do not match, please try again.");
                }
                else {
                    if (jsonDict.startYear != $("#startYearField").prop("defaultValue")) {
                        var ajaxObj = $.ajax({
                            url: "/api/user/setStartYear",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("setStartYear went wrong");
                            },
                        });
                        if (ajaxObj.status != 200) {
                            return false;
                        }
                    }
                    if (jsonDict.email != $("#emailField").prop("defaultValue")) {
                        var ajaxObj = $.ajax({
                            url: "/api/user/setEmail",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("setEmail went wrong");
                            },
                        });
                        if (ajaxObj.status != 200) {
                            return false;
                        }
                    }
                    if (jsonDict.password != "") {
                        var ajaxObj = $.ajax({
                            url: "/api/user/setPassword",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("setPassword went wrong");
                            },
                        });
                        if (ajaxObj.status != 200) {
                            return false;
                        }
                    }
                    uploadFile();
                }
            }
        </script>
    {% endif %}
{% endblock %}

{% block body %}
    {% if currUser and currUser == pageUser %}

<div class="containery">
    <div class="centery">
        <div class="reg-form-wrapper">
            <h1 class="text-center">Edit Profile</h1>
            
            {% if pageUser.image %}
            <img src="{{pageUser.image}}" class="user-icon-large"/>
            {% else %}
            <img src="/static/images/icon-default.png" class="user-icon-large"/>
            {% endif %}
            <br/>
            upload a new one?
            <br/>
            <input type="file" id="fileField" accept="image/*"/> max 10 MiB

            Username: {{pageUser}}
            <br/>
            you've been doing artist alley since <input type="number" min="1950" max="{% now "Y" %}" id="startYearField" value="{{pageUser.startYear}}"/>
            <br/>

            <br/>

            <br/>
            <input type="password" id="passField1" placeholder="new password?"/>
            <br/>
            <input type="password" id="passField2" placeholder="verify new password?"/>
            <br/>
            <input type="password" id="oldPassField" placeholder="put your current pw here if you're changing it"/>
            <br/>
            <input type="email" id="emailField" placeholder="email address" value="{{pageUser.email}}"/>
            <br/>
            <br/>
            <button onclick="updateProfile()" class="btn btn-custom-blue wide">Update</button>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="container">
    {{pageUser}}'s Profile
    <br/>    
    {% if pageUser.startYear %}
        they've been doing artist alley since {{pageUser.startYear}}
        <br/>
    {% endif %}
    their user avatar
    {% if pageUser.image %}
        <img src="{{pageUser.image}}"/>
    {% else %}
        <img src="/static/images/icon-default.png"/>

    {% endif %}
</div>
{% endif %}
{% endblock %}
