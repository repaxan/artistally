{% extends "includes/helper.html" %}

{% block head %}
    <title>Artistally User {{pageUser}}</title>
    {% if currUser and currUser == pageUser %}
        <script>
            function uploadFile() {
                var file = document.getElementById("fileField").files[0];
                var reader = new FileReader();
                reader.onloadend = function() {
                    var jsonDict = new Object();
                    jsonDict.file = reader.result.split(",")[1];
                    $.ajax({
                        url: "/api/util/uploadFile",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(jsonDict),
                        success: function(response) {
                            updateImage(response.url);
                        },
                        error: function(response) {
                            alert("uploadFile went wrong");
                        },
                    });
                }
                if (file) {
                    reader.readAsDataURL(file);
                }
            }
            
            function updateImage(url) {
                var jsonDict = new Object();
                jsonDict.image = url;
                var ajaxObj = $.ajax({
                    url: "/api/user/setImage",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(jsonDict),
                    async: false,
                    error: function(response) {
                        alert("setImage went wrong");
                    },
                });
                if (ajaxObj.status == 200) {
                    window.location.reload(true);
                }
            }
            
            function updateProfile() {
                var jsonDict = new Object();
                jsonDict.startYear = $("#startYearField").val();
                jsonDict.email = $("#emailField").val();
                jsonDict.password = $("#passField1").val();
                jsonDict.oldPassword = $("#oldPassField").val();
                if (jsonDict.password != $("#passField2").val()) {
                    alert("Your passwords do not match, please try again.");
                }
                else {
                    if (jsonDict.startYear != $("#startYearField").prop("defaultValue")) {
                        var ajaxObj = $.ajax({
                            url: "/api/user/setStartYear",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("setStartYear went wrong");
                            },
                        });
                        if (ajaxObj.status != 200) {
                            return false;
                        }
                    }
                    if (jsonDict.email != $("#emailField").prop("defaultValue")) {
                        var ajaxObj = $.ajax({
                            url: "/api/user/setEmail",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("setEmail went wrong");
                            },
                        });
                        if (ajaxObj.status != 200) {
                            return false;
                        }
                    }
                    if (jsonDict.password != "") {
                        var ajaxObj = $.ajax({
                            url: "/api/user/setPassword",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(jsonDict),
                            async: false,
                            error: function(response) {
                                alert("setPassword went wrong");
                            },
                        });
                        if (ajaxObj.status != 200) {
                            return false;
                        }
                    }
                    uploadFile();
                }
            }
            
            function chooseFile() {
                $("#fileField").click();
            }
            
            function showFileChosenMessage() {
                $("#fileChosenMessage").removeClass("hidden");
            }
            
        </script>
    {% endif %}
{% endblock %}

{% block body %}
    {% if currUser and currUser == pageUser %}

<div class="convention-form-wrapper form-wrapper">
    <h1 class="text-center title-wrapper">Edit Profile</h1>

    <div class="row">
        <div class="col-sm-3">
            <div class="text-center">
                {% if pageUser.image %}
                <img src="{{pageUser.image}}" class="user-icon-large"/>
                {% else %}
                <img src="/static/images/icon-default.png" class="user-icon-large"/>
                {% endif %}
                <br/>
                {{pageUser}}
                <br/>
                <br/>
                <input class="hidden" type="file" id="fileField" accept="image/*"/ onchange="showFileChosenMessage()">
                <p class="hidden" id="fileChosenMessage">File has been chosen.</p>
                <a onclick="chooseFile()" class="btn btn-custom-blue">Upload New Picture</a>
                <br/>
                Max 10 MiB
            </div>
        </div>
        <div class="col-sm-9">
            <div class="form-group">
                <label for="startYearField">Years in Artist Alley:</label>
                <input class="form-control" type="number" min="1950" max="{% now 'Y' %}" class="form-control" id="startYearField" value="{{pageUser.startYear}}"/>
            </div>    
        <!--            <input type="number" min="1950" max="{% now "Y" %}" id="startYearField" value="{{pageUser.startYear}}"/>-->
            <br/>

            <br/>

            <br/>
            <div class="input-group input-group-lg">
                <span class="input-group-addon" id="password1-addon"><i class="fa fa-key"></i></span>
                <input type="password" class="form-control" id="passField1" placeholder="New password" aria-describedby="password1-addon"/>
            </div>
        <!--            <input type="password" id="passField1" placeholder="new password?"/>-->
            <br/>
            <div class="input-group input-group-lg">
                <span class="input-group-addon" id="password2-addon"><i class="fa fa-key"></i></span>
                <input type="password" class="form-control" id="passField2" placeholder="Re-enter new password" aria-describedby="password2-addon"/>
            </div>
        <!--            <input type="password" id="passField2" placeholder="verify new password?"/>-->
            <br/>
             <div class="input-group input-group-lg">
                <span class="input-group-addon" id="oldpassword-addon"><i class="fa fa-key"></i></span>
                <input type="password" class="form-control" id="oldPassField" placeholder="Current password" aria-describedby="oldpassword-addon"/>
            </div>
        <!--            <input type="password" id="oldPassField" placeholder="put your current pw here if you're changing it"/>-->
            <br/>
            <div class="input-group input-group-lg">
                <span class="input-group-addon" id="email-addon"><i class="fa fa-envelope"></i></span>
                <input type="email" class="form-control" id="emailField" placeholder="New email" aria-describedby="login-addon"/>
            </div>
        </div>
    </div>
    <br/>
    <br/>
    <p class="text-right"><a onclick="updateProfile()" class="btn btn-custom-blue wide">Update Profile</a></p>
</div>
{% else %}
<div class="container">
    {{pageUser}}'s Profile
    <br/>    
    {% if pageUser.startYear %}
        they've been doing artist alley since {{pageUser.startYear}}
        <br/>
    {% endif %}
    their user avatar
    {% if pageUser.image %}
        <img src="{{pageUser.image}}"/>
    {% else %}
        <img src="/static/images/icon-default.png"/>
    {% endif %}
</div>
{% endif %}
{% endblock %}
